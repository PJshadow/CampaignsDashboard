<main> 
    <div class="container-fluid px-4">
        <h1 class="mt-4">Bem vindo, {{name}}</h1>
        <ul class="breadcrumb mb-4">
            <li class="breadcrumb-item active">Painel de Controle do Agente IA e Workflows</li>
        </ul>

        <div class="row">
            <!-- Coluna 1 -->
            <div class="col-sm-6 col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-chart-area me-1"></i>
                        Campanha em andamento
                    </div>
                    <div class="card-body">
                        <div id="campanhas-container">
                            <p>Carregando campanhas...</p>
                        </div>
                        <script>
                            function carregarCampanhas() {
                                fetch('/api/campanhas')
                                    .then(response => response.json())
                                    .then(data => {
                                        const container = document.getElementById('campanhas-container');
                                        container.innerHTML = '';

                                        if (data.length === 0) {
                                            container.innerHTML = '<p>Nenhuma campanha ativa no momento.</p>';
                                        } else {
                                            data.forEach(campanha => {
                                                const bloco = `
                                                    <div class="campanha">
                                                        <p><strong>Tipo de Campanha em Andamento:</strong> ${campanha.TipoDeCampanha}</p>
                                                        <p><strong>Tipo de Lead:</strong> ${campanha.TipoDeLead}</p>
                                                        <p><strong>Horário de Início:</strong> ${new Date(campanha.Inicio).toLocaleString()}</p>
                                                        <p><strong>Contatos feitos até o momento:</strong> ${campanha.leadsAlcancados}</p>
                                                        <p><strong>Local:</strong> ${campanha.Cidade}, ${campanha.estado}</p>
                                                    </div><br>
                                                `;
                                                container.innerHTML += bloco;
                                            });

                                            // Adiciona o botão "Parar Campanhas" somente se houver campanhas
                                            const botaoHTML = `
                                                <div class="text-center mt-4">
                                                    <button id="btn-parar-campanhas" class="btn btn-danger">
                                                        Parar Campanhas
                                                    </button>
                                                </div>
                                            `;
                                            container.innerHTML += botaoHTML;

                                            // Adiciona o evento ao botão
                                            document.getElementById('btn-parar-campanhas').addEventListener('click', () => {
                                                fetch('/stopcampaign', {
                                                    method: 'POST'
                                                })
                                                .then(response => response.text())
                                                .then(msg => {
                                                    alert(msg);
                                                    carregarCampanhas(); // Atualiza a lista após parar
                                                })
                                                .catch(error => {
                                                    console.error('Erro ao parar campanhas:', error);
                                                    alert('Erro ao tentar parar campanhas. Entre em contato com o suporte.');
                                                });
                                            });
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Erro ao carregar campanhas:', error);
                                        container.innerHTML = '<p>Erro ao carregar campanhas. Entre em contato com o suporte.</p>';
                                    });
                            }

                            setInterval(carregarCampanhas, 5000);
                            carregarCampanhas();
                        </script>   
                    </div>
                </div>
            </div>

            

            <!-- Coluna 2 -->
            <div class="col-sm-6 col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-chart-bar me-1"></i>
                        Leads Atingidos nos Últimos 5 Dias
                    </div>
                    <div class="card-body">
                        <canvas id="graficoLeadsPorData""></canvas>
                            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                            <script>
                                let chartInstance;

                                function atualizarGrafico() {
                                    try {
                                        const dados = {{{dadosGrafico}}}; // Atualize essa variável dinamicamente se possível

                                        const hoje = new Date();
                                        const ultimosCincoDias = [];
                                        for (let i = 4; i >= 0; i--) {
                                            const dia = new Date(hoje);
                                            dia.setDate(hoje.getDate() - i);
                                            const dataFormatada = dia.toLocaleDateString('pt-BR');
                                            ultimosCincoDias.push(dataFormatada);
                                        }

                                        const agrupadoPorData = {};
                                        dados.forEach(item => {
                                            const dataFormatada = new Date(item.inicio).toLocaleDateString('pt-BR');
                                            if (!agrupadoPorData[dataFormatada]) {
                                                agrupadoPorData[dataFormatada] = 0;
                                            }
                                            agrupadoPorData[dataFormatada] += item.leads;
                                        });

                                        const labels = ultimosCincoDias;
                                        const valores = labels.map(data => agrupadoPorData[data] || 0);

                                        const ctx = document.getElementById('graficoLeadsPorData').getContext('2d');

                                        if (chartInstance) {
                                            chartInstance.data.labels = labels;
                                            chartInstance.data.datasets[0].data = valores;
                                            chartInstance.update();
                                        } else {
                                            chartInstance = new Chart(ctx, {
                                                type: 'line',
                                                data: {
                                                    labels: labels,
                                                    datasets: [{
                                                        label: 'Total de Leads por Data de Início',
                                                        data: valores,
                                                        fill: false,
                                                        borderColor: 'rgba(54, 162, 235, 1)',
                                                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                                        tension: 0.3
                                                    }]
                                                },
                                                options: {
                                                    responsive: true,
                                                    scales: {
                                                        y: {
                                                            beginAtZero: true
                                                        }
                                                    }
                                                }
                                            });
                                        }
                                    } catch (e) {
                                        console.error("Erro ao atualizar gráfico de leads por data:", e);
                                    }
                                }

                                // Atualiza a cada 5 segundos
                                setInterval(atualizarGrafico, 5000);

                                // Primeira renderização
                                atualizarGrafico();
                            </script>


                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<script>
  // Script to capitalize the name
  const name = "{{name}}";

  // Function to capitalize the first letter
  function capitalizeFirstLetter(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  // Apply in HTML element
  document.addEventListener("DOMContentLoaded", function() {
    const header = document.querySelector("h1.mt-4");
    header.textContent = "Bem vindo, " + capitalizeFirstLetter(name);
  });
</script>

